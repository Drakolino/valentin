<script>
  const stage = document.getElementById('stage');
  const yesBtn = document.getElementById('yes');
  const noBtn  = document.getElementById('no');
  const result = document.getElementById('result');
  const hint   = document.getElementById('hint');
  const hearts = document.getElementById('hearts');
  const confettiLayer = document.getElementById('confetti');

  // âœ… Discord webhook
  const DISCORD_WEBHOOK = "https://discord.com/api/webhooks/1469489771620335863/lbfuuTnC-tyEpyetWNHjLRlB8_9nzGoUGvpTo5rQZTufSF6MhKk_jB2cbfx663AR9sn3";

  // ğŸ”‘ Token Ãºnico del link (ej: ?t=suzy_93KQ1)
  const TOKEN = new URLSearchParams(location.search).get("t") || "";

  async function sendToDiscord(answer){
    try{
      const payload = {
        username: "ValentÃ­n Bot ğŸ’˜",
        content: `ğŸ’Œ Respuesta: **${answer}**\nğŸ”‘ Token: **${TOKEN || "sin-token"}**\nğŸŒ PÃ¡gina: ${location.href}`
      };

      await fetch(DISCORD_WEBHOOK, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
    } catch (e) {
      console.warn("No se pudo enviar al webhook:", e);
    }
  }

  let yesScale = 1;
  let dodges = 0;

  // Para que sea juguetÃ³n pero justo:
  const MAX_DODGES = 7;       // cuÃ¡ntas veces se escapa el "No"
  const MAX_YES_SCALE = 2.15; // tamaÃ±o mÃ¡ximo del "SÃ­"

  // ---------- Floating hearts generator ----------
  const heartChars = ["ğŸ’—","ğŸ’–","ğŸ’˜","ğŸ’","ğŸ’","ğŸ’“","ğŸ’•"];
  function spawnHeart(){
    const h = document.createElement('div');
    h.className = 'heart';
    h.textContent = heartChars[Math.floor(Math.random()*heartChars.length)];
    const left = Math.random()*100;
    const dur = 6 + Math.random()*6; // 6-12s
    const size = 14 + Math.random()*14;
    h.style.left = left + 'vw';
    h.style.bottom = (-20 - Math.random()*40) + 'px';
    h.style.fontSize = size + 'px';
    h.style.animationDuration = dur + 's';
    h.style.animationDelay = (Math.random()*2) + 's';
    hearts.appendChild(h);
    setTimeout(() => h.remove(), (dur+3)*1000);
  }
  for(let i=0;i<10;i++) spawnHeart();
  setInterval(spawnHeart, 900);

  // ---------- Helpers ----------
  function place(btn, x, y) {
    const rect = stage.getBoundingClientRect();
    const b = btn.getBoundingClientRect();

    const maxX = rect.width - b.width - 10;
    const maxY = rect.height - b.height - 10;

    const clampedX = Math.max(10, Math.min(x, maxX));
    const clampedY = Math.max(10, Math.min(y, maxY));

    btn.style.left = clampedX + 'px';
    btn.style.top  = clampedY + 'px';
  }

  function randomSpot(btn) {
    const rect = stage.getBoundingClientRect();
    const b = btn.getBoundingClientRect();
    const x = Math.random() * (rect.width - b.width - 20) + 10;
    const y = Math.random() * (rect.height - b.height - 20) + 10;
    place(btn, x, y);
  }

  function growYes() {
    yesScale = Math.min(MAX_YES_SCALE, yesScale + 0.13);
    yesBtn.style.transform = `scale(${yesScale})`;
  }

  function setEndState() {
    yesBtn.disabled = true;
    noBtn.disabled = true;
    yesBtn.style.cursor = "default";
    noBtn.style.cursor = "default";
    noBtn.style.opacity = 0.75;
  }

  // ---------- Confetti ----------
  function confettiBurst() {
    const pieces = 120;
    const colors = ["#22c55e","#16a34a","#fb7185","#ef4444","#a855f7","#60a5fa","#f59e0b"];
    const w = window.innerWidth;

    for (let i=0;i<pieces;i++){
      const p = document.createElement('i');
      const x = Math.random()*w;
      const delay = Math.random()*0.15;
      const sizeW = 6 + Math.random()*8;
      const sizeH = 10 + Math.random()*14;

      p.style.left = x + "px";
      p.style.top = (-20 - Math.random()*60) + "px";
      p.style.width = sizeW + "px";
      p.style.height = sizeH + "px";
      p.style.background = colors[Math.floor(Math.random()*colors.length)];
      p.style.animationDelay = delay + "s";
      p.style.transform = `translateY(-20px) rotate(${Math.random()*180}deg)`;
      confettiLayer.appendChild(p);

      setTimeout(() => p.remove(), 1600);
    }
  }

  // ---------- Interactions ----------
  noBtn.addEventListener('mouseenter', () => {
    if (noBtn.disabled) return;

    if (dodges >= MAX_DODGES) {
      hint.textContent = "Ok ok ğŸ˜… ya puedes darle a 'No' si de verdad quieres.";
      return;
    }

    dodges++;
    growYes();
    randomSpot(noBtn);

    const remaining = MAX_DODGES - dodges;
    hint.textContent = remaining > 0
      ? `Intentos traviesos restantes: ${remaining} ğŸ˜ˆ`
      : "Ok ok ğŸ˜… ya puedes darle a 'No' si de verdad quieres.";
  });

  yesBtn.addEventListener('click', async () => {
    if (yesBtn.disabled) return;

    await sendToDiscord("SÃ ğŸ’š");

    result.textContent = "Yesss ğŸ¥¹ğŸ’š Â¡Entonces es una cita! Te escribo los detalles.";
    hint.textContent = "Prometido: la vamos a pasar bonito ğŸ˜Œ";
    confettiBurst();
    setEndState();
    yesBtn.style.transform = `scale(${Math.min(MAX_YES_SCALE, yesScale + 0.15)})`;
  });

  noBtn.addEventListener('click', async () => {
    if (noBtn.disabled) return;

    await sendToDiscord("NO ğŸ’”");

    result.textContent = "EstÃ¡ bien ğŸ’› Gracias por ser honesta. Cero presiÃ³n, todo bien ğŸ™‚";
    hint.textContent = "Si algÃºn dÃ­a te nace, me dices. Igual me caes sÃºper bien.";
    setEndState();
  });

  // ---------- Init positions ----------
  function initPositions(){
    place(yesBtn, stage.clientWidth * 0.29, stage.clientHeight * 0.60);
    place(noBtn,  stage.clientWidth * 0.62, stage.clientHeight * 0.38);
  }
  window.addEventListener('load', initPositions);
  window.addEventListener('resize', initPositions);
</script>
